<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="/game/p1/chatbot.css" />
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="application-name" content="Pseudo-3D Racer" />
    <meta name="author" content="AskForGameTask" />
    <meta name="description" content="A pseudo 3D racing game prototype." />
    <meta name="keywords" content="outrun, racer, racing, pseudo-3d, game, prototype" />
    <meta name="copyright" content="2021 Ask For Game Task" />
    <title>Pseudo-3D Racer</title>

    <style>
      body { margin: 0; overflow: hidden; }

      /* Background gradient */
      .animated-bg {
        position: fixed; inset: 0;
        z-index: 0;
        background: linear-gradient(135deg,
          #030616, #0a0f3c, #0d1b2a, #13223f,
          #1b2a4a, #243b6b, #0e2a47, #030616);
        background-size: 600% 600%;
        animation: gradientShift 45s ease-in-out infinite;
      }

      @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }

      /* Star layers */
      .diamond-layer, .diamond-mini-layer {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 1; 
        overflow: hidden;
      }

      /* Star styles */
      .diamond,
      .diamond-mini {
        position: absolute;
        transform: translate(-50%,-50%) rotate(45deg) scale(1);
        border-radius: 2px;
        background: linear-gradient(145deg, rgba(255,255,224,0.95), rgba(255,255,255,0.85));
        opacity: 0.85;
        animation: diamondTwinkle var(--twinkle, 6s) ease-in-out infinite;
        will-change: transform, opacity;
      }

      .diamond {
        width: var(--size, 4px);
        height: var(--size, 4px);
        box-shadow: 0 0 8px rgba(255,255,224,0.38),
                    0 0 16px rgba(255,255,180,0.25);
      }

      .diamond-mini {
        width: var(--size, 2px);
        height: var(--size, 2px);
        box-shadow: 0 0 6px rgba(255,255,224,0.28),
                    0 0 12px rgba(255,255,180,0.18);
      }

      @keyframes diamondTwinkle {
        0%   { transform: translate(-50%,-50%) rotate(45deg) scale(0.82); opacity: 0.15; }
        25%  { transform: translate(-50%,-50%) rotate(45deg) scale(1.04); opacity: 0.78; }
        50%  { transform: translate(-50%,-50%) rotate(45deg) scale(0.95); opacity: 0.50; }
        75%  { transform: translate(-50%,-50%) rotate(45deg) scale(1.10); opacity: 0.90; }
        100% { transform: translate(-50%,-50%) rotate(45deg) scale(0.82); opacity: 0.18; }
      }

      /* Ensure Phaser canvas sits above background/star layers */
      canvas {
        position: relative;
        z-index: 5;
        display: block;
      }
    </style>

    <!-- Phaser and game scripts -->
    <script src="../libs/phaser.min.js"></script>
    <script src="settings.js"></script>
    <script src="circuit.js"></script>
    <script src="player.js"></script>
    <script src="camera.js"></script>
    <script src="main.js"></script>
  </head>

  <body>
    <!-- Background gradient -->
    <div class="animated-bg"></div>

    <!-- Star layers -->
    <div class="diamond-layer"></div>
    <div class="diamond-mini-layer"></div>

    <!-- Chat overlay (top-left, over the road) -->
    <div id="chatRoot">
      <!-- Header -->
      <div class="card-header">
        <div class="img-avatar" aria-hidden="true"></div>
        <h3 class="text-chat">Your Match Awaits...</h3>
      </div>

      <!-- Question banner -->
      <div class="question-banner">
        <div id="questionCategory"></div>
        <h4 id="questionText"></h4>
        <p id="questionSubtext"></p>

        <div class="action-row">
          <button id="ttsToggle" type="button">Voice On</button>
          <button id="replayAudio" type="button" style="display:none;">
            <span id="replayText">Replay question</span>
          </button>
          <button id="backButton" type="button" style="display:none;">← Back</button>
          <button id="submitButton" type="button">Continue →</button>
        </div>
      </div>

      <!-- Loading -->
      <div id="loadingContainer" style="display:none;">
        <p id="loadingText"></p>
      </div>

      <!-- Messages + errors -->
      <div class="card-body">
        <div class="messages-container" id="questionContainer"></div>
        <div id="errorMessage" style="display:none;"><span id="errorText"></span></div>
      </div>

      <!-- Footer input -->
      <div class="card-footer">
        <div class="input-row">
          <textarea id="answerInput" rows="2" placeholder="Type your answer here…"></textarea>
          <button class="button-send" type="button" id="sendProxy">Send</button>
        </div>
        <div id="examplesContainer" style="display:none; padding:6px 2px 0 2px;">
          <p style="margin:0; font-size:12px; opacity:.8;">Examples:</p>
          <div id="examplesList" style="font-size:12px; opacity:.9;"></div>
        </div>
        <div id="tooltip" style="display:none; font-size:12px; opacity:.9; padding-top:6px;">
          <span id="tooltipText"></span>
        </div>
      </div>

      <!-- Hidden audio for TTS -->
      <audio id="ttsAudio"></audio>
    </div>

    <!-- Stars spawner -->
    <script>
      const starCount = 75;
      const miniStarCount = 150;
      const layer = document.querySelector('.diamond-layer');
      const miniLayer = document.querySelector('.diamond-mini-layer');

      for (let i = 0; i < starCount; i++) {
        const star = document.createElement('div');
        star.className = 'diamond';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.setProperty('--size', (Math.random() * 3 + 2) + 'px');
        star.style.setProperty('--twinkle', (Math.random() * 4 + 4) + 's');
        layer.appendChild(star);
      }
      for (let i = 0; i < miniStarCount; i++) {
        const star = document.createElement('div');
        star.className = 'diamond-mini';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.setProperty('--size', (Math.random() * 2 + 1) + 'px');
        star.style.setProperty('--twinkle', (Math.random() * 5 + 3) + 's');
        miniLayer.appendChild(star);
      }
    </script>

    <!-- Chat logic (uses your existing chatbot.js) -->
    <script src="/game/p1/chatbot.js"></script>
    <script>
      // Bridge: clicking “Send” should trigger your submit flow
      document.getElementById('sendProxy')?.addEventListener('click', () => {
        document.getElementById('submitButton')?.click();
      });

      // Optional helper to append bubbles from chatbot.js
      window.addBubble = function (text, side = 'left') {
        const wrap = document.querySelector('.messages-container');
        if (!wrap) return;
        const el = document.createElement('div');
        el.className = `message-box ${side === 'right' ? 'right' : 'left'}`;
        el.textContent = text;
        wrap.appendChild(el);
        wrap.parentElement.scrollTop = wrap.parentElement.scrollHeight;
      };
    </script>
  </body>
</html>
